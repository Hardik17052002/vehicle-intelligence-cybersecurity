import subprocess
from datetime import datetime
import re
import time

# Network interface and tools configuration
INTERFACE = 'eth0'  # Change to your actual interface

def pentest_listener(target, scan_type, sid,socketio_instance):
    """
    Real-time pentest listener that runs Nmap and Metasploit tools
    """
    # Import socketio here to avoid circular import
    
    def emit_pentest_output(message, level='info'):
        print(f"[pentest_listener] Emitting to SID {sid}: {message[:100]}...")
        try:
            socketio_instance.emit('pentest_output', {
                'message': message,
                'level': level,
                'timestamp': datetime.now().strftime("%H:%M:%S")
            }, room=sid)
            socketio_instance.sleep(0)  # Yield to eventlet
            print("‚úì Pentest event emitted successfully")
        except Exception as e:
            print(f"‚úó Pentest emit error: {e}")
    
    print(f"üîç Starting pentest listener for target: {target}, type: {scan_type}, SID: {sid}")
    
    # Initial status message
    emit_pentest_output(f"Starting automated pentest against {target} ({scan_type})", 'info')
    
    try:
        if scan_type == 'network':
            run_network_scan(target, emit_pentest_output, sid)
        elif scan_type == 'web':
            run_web_scan(target, emit_pentest_output, sid)
        elif scan_type == 'os':
            run_os_scan(target, emit_pentest_output, sid)
        else:
            emit_pentest_output(f"Unknown scan type: {scan_type}", 'critical')
            
    except Exception as e:
        print(f"üí• Pentest error: {e}")
        emit_pentest_output(f"Pentest error: {str(e)}", 'critical')

def run_network_scan(target, emit_func, sid):
    """Run Nmap network scan"""
    emit_func("üîç Starting Nmap network reconnaissance...", 'info')
    
    # Nmap command for network scanning
    cmd = [
        'nmap', 
        '-sS',  # SYN scan
        '-O',   # OS detection
        '-sV',  # Service version detection
        '--top-ports', '1000',
        target
    ]
    
    try:
        emit_func(f"Running command: {' '.join(cmd)}", 'info')
        
        with subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE, 
                             text=True, bufsize=1) as proc:
            emit_func("‚úì Nmap process started", 'info')
            
            for line in proc.stdout:
                line = line.strip()
                if line:
                    # Parse and categorize Nmap output
                    if 'open' in line.lower():
                        emit_func(f"üîì Open port found: {line}", 'high')
                    elif 'filtered' in line.lower():
                        emit_func(f"üõ°Ô∏è Filtered port: {line}", 'medium')
                    elif 'os details' in line.lower():
                        emit_func(f"üñ•Ô∏è OS Detection: {line}", 'info')
                    elif 'service' in line.lower():
                        emit_func(f"‚öôÔ∏è Service detected: {line}", 'info')
                    else:
                        emit_func(line, 'info')
            
            # Check for completion
            return_code = proc.wait()
            if return_code == 0:
                emit_func("‚úÖ Network scan completed successfully", 'info')
            else:
                emit_func(f"‚ö†Ô∏è Network scan completed with warnings (code: {return_code})", 'medium')
                
    except FileNotFoundError:
        emit_func("‚ùå Nmap not found. Install with: sudo apt install nmap", 'critical')
    except Exception as e:
        emit_func(f"‚ùå Network scan error: {str(e)}", 'critical')

def run_web_scan(target, emit_func, sid):
    """Run Nikto web vulnerability scan"""
    emit_func("üåê Starting Nikto web vulnerability scan...", 'info')
    
    # Nikto command for web scanning
    cmd = [
        'nikto',
        '-h', target,
        '-Format', 'txt',
        '-nointeractive'
    ]
    
    try:
        emit_func(f"Running command: {' '.join(cmd)}", 'info')
        
        with subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE,
                             text=True, bufsize=1) as proc:
            emit_func("‚úì Nikto process started", 'info')
            
            for line in proc.stdout:
                line = line.strip()
                if line:
                    # Parse Nikto output for vulnerabilities
                    if 'osvdb' in line.lower() or 'cve' in line.lower():
                        emit_func(f"üö® Vulnerability found: {line}", 'critical')
                    elif 'info:' in line.lower():
                        emit_func(f"‚ÑπÔ∏è Info: {line}", 'info')
                    elif 'error' in line.lower():
                        emit_func(f"‚ùå Error: {line}", 'medium')
                    else:
                        emit_func(line, 'info')
            
            return_code = proc.wait()
            if return_code == 0:
                emit_func("‚úÖ Web scan completed successfully", 'info')
            else:
                emit_func(f"‚ö†Ô∏è Web scan completed with warnings", 'medium')
                
    except FileNotFoundError:
        emit_func("‚ùå Nikto not found. Install with: sudo apt install nikto", 'critical')
    except Exception as e:
        emit_func(f"‚ùå Web scan error: {str(e)}", 'critical')

def run_os_scan(target, emit_func, sid):
    """Run OS-specific vulnerability scan"""
    emit_func("üñ•Ô∏è Starting OS vulnerability assessment...", 'info')
    
    # Use Nmap for OS detection and vulnerability scripts
    cmd = [
        'nmap',
        '-O',  # OS detection
        '--script', 'vuln',  # Vulnerability scripts
        '--script-args', 'unsafe=1',
        target
    ]
    
    try:
        emit_func(f"Running command: {' '.join(cmd)}", 'info')
        
        with subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE,
                             text=True, bufsize=1) as proc:
            emit_func("‚úì OS vulnerability scan started", 'info')
            
            for line in proc.stdout:
                line = line.strip()
                if line:
                    # Parse vulnerability script output
                    if 'vulnerable' in line.lower():
                        emit_func(f"üö® Vulnerability: {line}", 'critical')
                    elif 'exploit' in line.lower():
                        emit_func(f"üí£ Potential exploit: {line}", 'high')
                    elif 'cve' in line.lower():
                        emit_func(f"üîç CVE found: {line}", 'high')
                    else:
                        emit_func(line, 'info')
            
            return_code = proc.wait()
            if return_code == 0:
                emit_func("‚úÖ OS scan completed successfully", 'info')
            else:
                emit_func(f"‚ö†Ô∏è OS scan completed with warnings", 'medium')
                
    except FileNotFoundError:
        emit_func("‚ùå Nmap not found. Install with: sudo apt install nmap", 'critical')
    except Exception as e:
        emit_func(f"‚ùå OS scan error: {str(e)}", 'critical')
